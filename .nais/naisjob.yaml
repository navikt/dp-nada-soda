apiVersion: nais.io/v1
kind: Naisjob
metadata:
  labels:
    team: nada
  name: tester-soda
  namespace: nada
spec:
  image: {{ image }}
  accessPolicy:
    outbound:
      external:
      - host: hooks.slack.com
  env:
    - name: SODA_CONFIG
      value: /var/run/configmaps/soda-config/config.yaml
    - name: SODA_CHECKS_FOLDER
      value: /var/run/configmaps/soda-checks
    - name: SLACK_CHANNEL
      value: "#soda-test"
  schedule: '15 11 * * *'
  failedJobsHistoryLimit: 1
  successfulJobsHistoryLimit: 1
  backoffLimit: 1
  concurrencyPolicy: Forbid
  filesFrom:
    - configmap: soda-checks
    - configmap: soda-config
  envFrom:
    - secret: slack-token
  gcp:
    permissions:
    - resource:
        apiVersion: resourcemanager.cnrm.cloud.google.com/v1beta1
        kind: Project
        name: nada-prod-6977
      role: roles/bigquery.readSessionUser
    - resource:
        apiVersion: resourcemanager.cnrm.cloud.google.com/v1beta1
        kind: Project
        name: nada-prod-6977
      role: roles/bigquery.dataViewer
    - resource:
        apiVersion: resourcemanager.cnrm.cloud.google.com/v1beta1
        kind: Project
        name: nada-prod-6977
      role: roles/bigquery.jobUser
